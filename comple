library(tidyverse)
library(KnowBR)
library(raster)
library(ggplot2)
library(viridis)
library(rnaturalearth)

#### Completeness per grids with incidence data

d <- readRDS("d.rds")

# adding incidence value for each record

d$records <- 1

# community matrix IDplots x species
d3 <- d %>%
  dplyr::select(Species, PlotObservationID, records)%>%
  pivot_wider(names_from =Species, values_from = records, id_cols=PlotObservationID, values_fn = list(records = sum), values_fill = 0)%>%
  mutate(across(where(is.numeric), round, 0)) %>% unique()
  
#length(unique(d$PlotObservationID))
#[1] 10501
#length(unique(d$Species))
#[1] 5441

# select coordinates for each plot

y1 <- d %>% dplyr::select(PlotObservationID, Longitude,  Latitude) %>% unique()

# create table format B for KnowBR format B
d3 <- merge(d3, y1, by="PlotObservationID") 


d3 <- d3[,-1]
d3 <- d3 %>% relocate(c( Longitude, Latitude), .before = "Aegopodium podagraria")

size<- 0.5


polygon.sp<- as(polygon, "Spatial")
hex_points <- spsample(polygon.sp, type = "hexagonal", cellsize= size)
hex_grid <- HexPoints2SpatialPolygons(hex_points, dx = size)
hex_grid_sf <- st_as_sf(hex_grid)
hex_grid_sf$id <- 1:131040

hex_grid.d <- left_join(d, hex_grid_sf, by= "id") %>% dplyr::select(id, geometry)

data(adworld)                    
KnowBPolygon(data=d3, save="CSV", format="B", shape=hex_grid.d, shapenames="id") # 0.5 degree

######### Estimator is the table that contains the completeness values

est <- read.csv("Estimators.CSV", header=T, sep=";")
est$Latitude <- gsub(est$Latitude,pattern = ',',replacement = '.')
est$Longitude <- gsub(est$Longitude,pattern = ',',replacement = '.')
est$Completeness <- gsub(est$Completeness,pattern = ',',replacement = '.')

comp <- est %>% dplyr::select(Longitude, Latitude, Completeness) %>% drop_na() ### drop_na() solo per plots
comp$Longitude <-as.numeric(comp[,1])
comp$Latitude <-as.numeric(comp[,2])
comp$Completeness <-as.numeric(comp[,3])


